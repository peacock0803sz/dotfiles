on:
  workflow_dispatch:
  schedule:
    - cron: 0 16 * * * # everyday 01:00 JST

jobs:
  update-nix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: update-flake
        shell: bash
        run: nix flake update

      - name: git-commit
        shell: bash
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "github-actions[bot]"
          GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"
        run: |
          if [[ $(git status --untracked-files --short) ]]; then
            git add .
            git commit -m "Update flake.lock"
            git push origin HEAD
          else
            echo "Nothing to commit"
          fi

  update-node2nix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        host: [nocturne, arpeggio]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: update-node2nix
        working-directory: .config/nix/hosts/${{ matrix.host }}/node2nix
        shell: bash
        run: nix-shell -p nodePackages.node2nix --command "node2nix -i ./node-packages.json -o node-packages.nix"

      - name: git-commit
        shell: bash
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
          GIT_COMMITTER_NAME: "github-actions[bot]"
          GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"
        run: |
          if [[ $(git status --untracked-files --short) ]]; then
            git add .
            git commit -m "Update flake.lock"
            git push origin HEAD
          else
            echo "Nothing to commit"
          fi
